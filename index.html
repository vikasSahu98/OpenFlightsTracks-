<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flight Tracking System — Smooth Continuous Movement (Full File)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --------------------------------------------------
           General layout & theming
           -------------------------------------------------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #0d1b2a;
            color: #e0e1dd;
            overflow: hidden;
        }

        header {
            background-color: #1b263b;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        h1 {
            text-align: center;
            margin-bottom: 1rem;
            color: #e0e1dd;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 0.5rem;
            background-color: #415a77;
            border-radius: 8px;
        }

        select,
        button,
        input {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            background-color: #778da9;
            color: #0d1b2a;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.25s;
        }

        select:hover,
        button:hover,
        input:hover {
            background-color: #e0e1dd;
        }

        #map {
            flex: 1;
            z-index: 1;
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(27, 38, 59, 0.92);
            padding: 1rem;
            border-radius: 8px;
            z-index: 1000;
            max-width: 320px;
            backdrop-filter: blur(8px);
        }

        .aircraft-info {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #778da9;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(27, 38, 59, 0.92);
            padding: 1rem;
            border-radius: 8px;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            border-radius: 6px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem;
            background-color: #1b263b;
            font-size: 0.9rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            color: #778da9;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(27, 38, 59, 0.95);
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 1001;
            text-align: center;
        }

        .performance-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 0.5rem;
            background-color: #1b263b;
        }

        .performance-slider {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="range"] {
            width: 150px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }

            .info-panel,
            .legend {
                max-width: 200px;
                font-size: 0.8rem;
            }

            .performance-controls {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Aircraft icon styles */
        .aircraft-icon {
            transition: transform 0.25s linear;
            display: block;
        }

        .aircraft-icon.commercial {
            color: #4cc9f0;
        }

        .aircraft-icon.private {
            color: #f72585;
        }

        .aircraft-icon.cargo {
            color: #7209b7;
        }

        .aircraft-icon.military {
            color: #3a0ca3;
        }

        .aircraft-icon.general {
            color: #4361ee;
        }

        .aircraft-marker {
            pointer-events: auto;
        }

        /* small visual helper for popup readability */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 30, 40, 0.98);
            color: #e0e1dd;
        }
    </style>
</head>

<body>
    <header>
        <h1>Flight Tracking System</h1>
        <div class="controls">
            <select id="view-select">
                <option value="all">All Flights</option>
                <option value="sensor">By Sensor</option>
                <option value="aircraft">By Aircraft</option>
            </select>

            <select id="sensor-select" style="display: none;">
                <option value="0">All Sensors</option>
                <option value="1">ADS-B</option>
                <option value="2">ASTERIX</option>
                <option value="3">MLAT</option>
                <option value="4">FLARM</option>
            </select>

            <input type="text" id="aircraft-input" placeholder="ICAO24 Code" style="display: none;">

            <button id="toggle-tracks">Show Tracks</button>
            <button id="update-data">Update Data</button>
            <button id="reset-view">Reset View</button>
            <button id="fullscreen-map">Fullscreen Map</button>
        </div>
    </header>

    <div class="performance-controls">
        <div class="performance-slider">
            <label for="update-interval">Update Interval:</label>
            <input type="range" id="update-interval" min="1" max="10" value="3">
            <span id="interval-value">3s</span>
        </div>
        <div class="performance-slider">
            <label for="max-flights">Max Flights:</label>
            <input type="range" id="max-flights" min="10" max="500" value="100">
            <span id="max-flights-value">100</span>
        </div>
        <button id="toggle-animation">Pause Animation</button>
    </div>

    <div class="stats">
        <div class="stat-item">Active Flights: <span class="stat-value" id="active-flights">0</span></div>
        <div class="stat-item">Last Update: <span class="stat-value" id="last-update">-</span></div>
        <div class="stat-item">Visible: <span class="stat-value" id="visible-flights">0</span></div>
        <div class="stat-item">FPS: <span class="stat-value" id="fps-counter">0</span></div>
    </div>

    <div id="map"></div>

    <div class="loading" id="loading-indicator">Loading flight data...</div>

    <div class="info-panel">
        <h3>Flight Information</h3>
        <p>Select an aircraft to view details</p>
        <div class="aircraft-info" id="aircraft-details"></div>
    </div>

    <div class="legend">
        <h4>Legend</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4cc9f0;"></div>
            <span>Commercial</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #f72585;"></div>
            <span>Private</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #7209b7;"></div>
            <span>Cargo</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #3a0ca3;"></div>
            <span>Military</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4361ee;"></div>
            <span>General Aviation</span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Lodash for utilities (kept from original) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

    <!-- Main JS Logic -->
    <script>
        // Map init
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Performance & state
        let updateInterval = 3000; // ms
        let maxFlightsToShow = 100;
        let animationEnabled = true;
        let intervalId = null;

        // Storage: markers, tracks, raw data
        const aircraftMarkers = {};   // icao24 -> L.marker
        const aircraftTracks = {};    // icao24 -> L.polyline
        const aircraftData = {};      // icao24 -> latest state

        // FPS tracking
        let lastFPSCheck = performance.now();
        let frameCounter = 0;

        // ------------------------- helpers ------------------------------
        function showLoading() { document.getElementById('loading-indicator').style.display = 'block'; }
        function hideLoading() { document.getElementById('loading-indicator').style.display = 'none'; }

        function createAircraftIcon(category) {
            const className = `aircraft-icon ${category || ''}`;
            return L.divIcon({
                html: `<svg width="28" height="28" viewBox="0 0 24 24" class="${className}">
                        <path fill="currentColor" d="M22 16v-2l-8.5-5V3.5c0-.83-.67-1.5-1.5-1.5S10.5 2.67 10.5 3.5V9L2 14v2l8.5-2.5V19L8 20.5V22l4-1 4 1v-1.5L13.5 19v-5.5L22 16z"/>
                       </svg>`,
                className: 'aircraft-marker',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
        }

        // Apply rotation to svg inside marker element
        function applyRotationToMarker(marker, angleDeg) {
            const el = marker.getElement();
            if (!el) return;
            const svg = el.querySelector('svg');
            if (!svg) return;
            svg.style.transformOrigin = '50% 50%';
            svg.style.transform = `rotate(${angleDeg}deg)`;
        }

        // ---------------------- simulated data generator -----------------
        // This matches the format used earlier: { states: [ { icao24, latitude, longitude, velocity, trueTrack, ... }, ... ] }
        function generateSimulatedFlightData() {
            const flights = {};
            const count = Math.min(maxFlightsToShow, 100 + Math.floor(Math.random() * 50));

            for (let i = 0; i < count; i++) {
                const icao24 = `abc${100 + Math.floor(Math.random() * 900)}`;

                if (aircraftData[icao24]) {
                    const flight = aircraftData[icao24];
                    const speed = Math.max(1, (flight.velocity || 200) + (Math.random() - 0.5) * 20); // m/s
                    const bearing = (flight.trueTrack !== undefined ? flight.trueTrack : Math.random() * 360) + (Math.random() - 0.5) * 2;

                    const distanceMeters = speed * (updateInterval / 1000);
                    const bearingRad = bearing * Math.PI / 180;
                    const lat = flight.latitude + (distanceMeters / 111320) * Math.cos(bearingRad);
                    const lng = flight.longitude + (distanceMeters / (111320 * Math.cos(flight.latitude * Math.PI / 180))) * Math.sin(bearingRad);

                    flights[icao24] = {
                        ...flight,
                        latitude: lat,
                        longitude: lng,
                        velocity: speed,
                        trueTrack: (bearing + 360) % 360,
                        lastUpdate: Date.now()
                    };
                } else {
                    const categories = ['commercial', 'private', 'cargo', 'military', 'general'];
                    const category = categories[Math.floor(Math.random() * categories.length)];

                    flights[icao24] = {
                        icao24: icao24,
                        callsign: `FLT${1000 + Math.floor(Math.random() * 9000)}`,
                        originCountry: ['USA', 'GER', 'FRA', 'UK', 'JPN', 'AUS'][Math.floor(Math.random() * 6)],
                        longitude: -180 + Math.random() * 360,
                        latitude: -60 + Math.random() * 120,
                        baroAltitude: Math.random() * 12000,
                        velocity: 100 + Math.random() * 200, // m/s
                        trueTrack: Math.random() * 360,
                        verticalRate: -20 + Math.random() * 40,
                        onGround: false,
                        category: category,
                        positionSource: Math.floor(Math.random() * 5),
                        lastUpdate: Date.now()
                    };
                }
            }

            return { states: Object.values(flights) };
        }

        // --------------------- process server data -----------------------
        function processFlightData(data) {
            const viewFilter = document.getElementById('view-select').value;
            const sensorFilter = document.getElementById('sensor-select').value;
            const aircraftFilter = document.getElementById('aircraft-input').value.toUpperCase();

            let activeCount = 0;
            let visibleCount = 0;

            if (data.states && Array.isArray(data.states)) {
                data.states.forEach(state => {
                    const icao24 = state.icao24;
                    aircraftData[icao24] = state;

                    if (viewFilter === 'sensor' && sensorFilter !== '0' && state.positionSource != sensorFilter) {
                        return;
                    }

                    if (viewFilter === 'aircraft' && aircraftFilter && !icao24.includes(aircraftFilter)) {
                        return;
                    }

                    activeCount++;

                    if (state.latitude !== undefined && state.longitude !== undefined) {
                        visibleCount++;

                        if (aircraftMarkers[icao24]) {
                            const marker = aircraftMarkers[icao24];

                            // Update predictive metadata (do NOT snap marker). We'll blend/predict in animation loop.
                            marker._state = state;
                            marker._speed = state.velocity || 0; // m/s
                            marker._track = (state.trueTrack !== undefined && state.trueTrack !== null) ? state.trueTrack : marker._track || 0;
                            marker._lastServerUpdate = Date.now();

                            // Rebase predicted anim position to current visual position to avoid sudden jumps
                            const currentLatLng = marker.getLatLng();
                            marker._animLat = currentLatLng.lat;
                            marker._animLng = currentLatLng.lng;
                            marker._animTime = performance.now();

                            // update popup content
                            const popupContent = `\
                                <strong>${state.callsign}</strong><br>\
                                ICAO24: ${icao24}<br>\
                                Country: ${state.originCountry}<br>\
                                Type: ${state.category}<br>\
                                Altitude: ${state.baroAltitude ? Math.round(state.baroAltitude) + ' m' : 'N/A'}<br>\
                                Velocity: ${state.velocity ? Math.round(state.velocity * 3.6) + ' km/h' : 'N/A'}<br>\
                                Track: ${state.trueTrack ? Math.round(state.trueTrack) + '°' : 'N/A'}`;

                            marker.getPopup() && marker.setPopupContent(popupContent);

                            // draw track polyline if enabled
                            if (window._tracksVisible && aircraftTracks[icao24]) {
                                const latlngs = aircraftTracks[icao24].getLatLngs();
                                latlngs.push([state.latitude, state.longitude]);
                                // keep track length reasonable
                                if (latlngs.length > 50) latlngs.shift();
                                aircraftTracks[icao24].setLatLngs(latlngs);
                            }

                        } else {
                            // create marker for new flight
                            const marker = L.marker([state.latitude, state.longitude], {
                                icon: createAircraftIcon(state.category)
                            }).addTo(map);

                            // store predictive fields used by animation
                            marker._state = state;
                            marker._speed = state.velocity || 0;
                            marker._track = (state.trueTrack !== undefined && state.trueTrack !== null) ? state.trueTrack : 0;
                            marker._animLat = state.latitude;
                            marker._animLng = state.longitude;
                            marker._animTime = performance.now();
                            marker._lastServerUpdate = Date.now();

                            marker.on('add', () => applyRotationToMarker(marker, marker._track));

                            const popupContent = `\
                                <strong>${state.callsign}</strong><br>\
                                ICAO24: ${icao24}<br>\
                                Country: ${state.originCountry}<br>\
                                Type: ${state.category}<br>\
                                Altitude: ${state.baroAltitude ? Math.round(state.baroAltitude) + ' m' : 'N/A'}<br>\
                                Velocity: ${state.velocity ? Math.round(state.velocity * 3.6) + ' km/h' : 'N/A'}<br>\
                                Track: ${state.trueTrack ? Math.round(state.trueTrack) + '°' : 'N/A'}`;

                            marker.bindPopup(popupContent);

                            marker.on('click', () => {
                                const detailsElement = document.getElementById('aircraft-details');
                                detailsElement.innerHTML = `\
                                    <strong>${state.callsign}</strong><br>\
                                    ICAO24: ${icao24}<br>\
                                    Country: ${state.originCountry}<br>\
                                    Type: ${state.category}<br>\
                                    Altitude: ${state.baroAltitude ? Math.round(state.baroAltitude) + ' m' : 'N/A'}<br>\
                                    Velocity: ${state.velocity ? Math.round(state.velocity * 3.6) + ' km/h' : 'N/A'}<br>\
                                    Track: ${state.trueTrack ? Math.round(state.trueTrack) + '°' : 'N/A'}<br>\
                                    Vertical Rate: ${state.verticalRate ? Math.round(state.verticalRate) + ' m/s' : 'N/A'}<br>\
                                    On Ground: ${state.onGround ? 'Yes' : 'No'}`;
                            });

                            aircraftMarkers[icao24] = marker;

                            // create a track polyline (optional) and keep reference
                            if (window._tracksVisible) {
                                const poly = L.polyline([[state.latitude, state.longitude]], { weight: 2, opacity: 0.8 }).addTo(map);
                                aircraftTracks[icao24] = poly;
                            }
                        }
                    }
                });
            }

            // Remove markers for flights absent in aircraftData
            for (const icao in aircraftMarkers) {
                if (!aircraftData[icao]) {
                    try { map.removeLayer(aircraftMarkers[icao]); } catch (e) { }
                    delete aircraftMarkers[icao];

                    if (aircraftTracks[icao]) {
                        try { map.removeLayer(aircraftTracks[icao]); } catch (e) { }
                        delete aircraftTracks[icao];
                    }
                }
            }

            document.getElementById('active-flights').textContent = activeCount;
            document.getElementById('visible-flights').textContent = visibleCount;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // ---------------------- continuous animation loop -----------------------
        // Integrate movement for each marker every frame using speed (m/s) and track (deg). This prevents
        // stuttering when server updates are sparse and keeps motion smooth.
        function animationLoop(now) {
            frameCounter++;

            if (now - lastFPSCheck >= 1000) {
                document.getElementById('fps-counter').textContent = String(frameCounter);
                frameCounter = 0;
                lastFPSCheck = now;
            }

            if (animationEnabled) {
                const nowMs = now;
                for (const icao24 in aircraftMarkers) {
                    const marker = aircraftMarkers[icao24];

                    if (marker._animTime === undefined) {
                        marker._animTime = nowMs;
                        const ll = marker.getLatLng();
                        marker._animLat = ll.lat;
                        marker._animLng = ll.lng;
                    }

                    const dt = Math.min(0.5, (nowMs - (marker._animTime || nowMs)) / 1000);
                    if (dt <= 0) continue;

                    const speed = marker._speed || 0; // m/s
                    const distanceMeters = speed * dt;
                    const track = (marker._track !== undefined && marker._track !== null) ? marker._track : 0;
                    const bearingRad = (track * Math.PI) / 180;

                    const latRad = (marker._animLat * Math.PI) / 180 || 0;
                    const deltaLatDeg = (distanceMeters / 111320) * Math.cos(bearingRad);
                    const deltaLngDeg = (distanceMeters / (111320 * Math.max(0.0001, Math.cos(latRad)))) * Math.sin(bearingRad);

                    marker._animLat = marker._animLat + deltaLatDeg;
                    marker._animLng = marker._animLng + deltaLngDeg;
                    marker._animTime = nowMs;

                    try { marker.setLatLng([marker._animLat, marker._animLng]); } catch (e) { }

                    applyRotationToMarker(marker, track);
                }
            }

            requestAnimationFrame(animationLoop);
        }

        // ---------------------- data fetch / scheduling -----------------------
        async function fetchFlightData() {
            if (!animationEnabled) return;
            showLoading();
            try {
                // Replace this with real API call if you have credentials/rate limits handled
                const simulated = generateSimulatedFlightData();
                processFlightData(simulated);
            } catch (err) {
                console.error('Error fetching data', err);
            } finally {
                hideLoading();
            }
        }

        // ---------------------- UI event handlers -------------------------
        document.getElementById('view-select').addEventListener('change', function () {
            const view = this.value;
            document.getElementById('sensor-select').style.display = view === 'sensor' ? 'inline-block' : 'none';
            document.getElementById('aircraft-input').style.display = view === 'aircraft' ? 'inline-block' : 'none';
            fetchFlightData();
        });

        document.getElementById('sensor-select').addEventListener('change', fetchFlightData);
        document.getElementById('aircraft-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') fetchFlightData(); });

        document.getElementById('toggle-tracks').addEventListener('click', function () {
            window._tracksVisible = !window._tracksVisible;
            this.textContent = window._tracksVisible ? 'Hide Tracks' : 'Show Tracks';

            // Add or remove polyline layers for existing markers
            if (window._tracksVisible) {
                for (const icao in aircraftMarkers) {
                    if (!aircraftTracks[icao]) {
                        const ll = aircraftMarkers[icao].getLatLng();
                        const poly = L.polyline([[ll.lat, ll.lng]], { weight: 2, opacity: 0.8 }).addTo(map);
                        aircraftTracks[icao] = poly;
                    }
                }
            } else {
                for (const icao in aircraftTracks) {
                    try { map.removeLayer(aircraftTracks[icao]); } catch (e) { }
                    delete aircraftTracks[icao];
                }
            }
        });

        // ---------------------- Fullscreen Map -------------------------
        document.getElementById('fullscreen-map').addEventListener('click', function () {
            const mapDiv = document.getElementById('map');
            if (!document.fullscreenElement) {
                if (mapDiv.requestFullscreen) {
                    mapDiv.requestFullscreen();
                } else if (mapDiv.webkitRequestFullscreen) { /* Safari */
                    mapDiv.webkitRequestFullscreen();
                } else if (mapDiv.msRequestFullscreen) { /* IE11 */
                    mapDiv.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });


        document.getElementById('update-data').addEventListener('click', fetchFlightData);

        document.getElementById('reset-view').addEventListener('click', function () {
            map.setView([20.5937, 78.9629], 5);
            document.getElementById('view-select').value = 'all';
            document.getElementById('sensor-select').style.display = 'none';
            document.getElementById('aircraft-input').style.display = 'none';
            document.getElementById('aircraft-input').value = '';
            document.getElementById('aircraft-details').innerHTML = '';
            fetchFlightData();
        });

        document.getElementById('update-interval').addEventListener('input', function () {
            updateInterval = this.value * 1000;
            document.getElementById('interval-value').textContent = this.value + 's';
            clearInterval(intervalId);
            intervalId = setInterval(fetchFlightData, updateInterval);
        });

        document.getElementById('max-flights').addEventListener('input', function () {
            maxFlightsToShow = parseInt(this.value, 10);
            document.getElementById('max-flights-value').textContent = this.value;
        });

        document.getElementById('toggle-animation').addEventListener('click', function () {
            animationEnabled = !animationEnabled;
            this.textContent = animationEnabled ? 'Pause Animation' : 'Resume Animation';
            if (animationEnabled) {
                clearInterval(intervalId);
                intervalId = setInterval(fetchFlightData, updateInterval);
                fetchFlightData();
            } else {
                clearInterval(intervalId);
            }
        });

        // cleanup on unload
        window.addEventListener('beforeunload', function () {
            clearInterval(intervalId);
        });

        // ---------------------- bootstrap -------------------------
        window._tracksVisible = false;
        intervalId = setInterval(fetchFlightData, updateInterval);
        fetchFlightData();
        requestAnimationFrame(animationLoop);

        // Expose helpers for debugging from console
        window._aircraftMarkers = aircraftMarkers;
        window._aircraftData = aircraftData;
        window._aircraftTracks = aircraftTracks;
    </script>
</body>
</html>